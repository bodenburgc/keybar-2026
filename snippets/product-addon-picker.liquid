{%- doc -%}
  Renders an add-on product picker with image cards and variant swatches.

  Displays linked products as clickable image cards with product photos.
  Selected add-on variant is added to cart alongside main product.

  @param {object} product - The main product being viewed
  @param {string} section_id - Section ID for unique element IDs
  @param {object} block - Block settings from schema
  @param {string} product_form_id - ID of the main product form

  @example
  {%- render 'product-addon-picker',
    product: product,
    section_id: section.id,
    block: block,
    product_form_id: product_form_id
  -%}
{%- enddoc -%}

{%- liquid
  # Check if add-on is enabled for this product
  assign addon_enabled = product.metafields.custom.enable_clip_add_on.value

  unless addon_enabled
    break
  endunless

  # Get linked add-on products
  assign addon_products = product.metafields.custom.clip_addon_products.value
-%}

{%- liquid
  if addon_products == blank or addon_products.size == 0
    break
  endif

  # Get customizable text
  assign addon_title = product.metafields.custom.clip_addon_title.value | default: 'Pocket Clip'
  assign addon_description = product.metafields.custom.clip_addon_description.value | default: 'Select your titanium pocket clip color or upgrade to the deep carry pocket clip.'

  # First product is the default
  assign default_addon = addon_products.first
  assign default_variant = default_addon.selected_or_first_available_variant
-%}

{{ 'product-addon.css' | asset_url | stylesheet_tag }}
<script src="{{ 'product-addon.js' | asset_url }}" defer="defer"></script>

<product-addon
  class="product-addon block"
  id="ProductAddon-{{ section_id }}"
  data-section-id="{{ section_id }}"
  data-default-variant-id="{{ default_variant.id }}"
  data-form-id="{{ product_form_id }}"
  {{ block.shopify_attributes }}
>
  {%- # Section Header -%}
  <div class="product-addon__header flex flex-col gap-2 mb-4">
    <h3 class="product-addon__title heading text-base font-semibold">
      {{ addon_title }}
    </h3>
    {%- if addon_description != blank -%}
      <p class="product-addon__description text-sm text-opacity">
        {{ addon_description }}
      </p>
    {%- endif -%}
  </div>

  {%- # Product Selector Image Cards -%}
  <fieldset class="product-addon__selector mb-4">
    <legend class="form__label text-sm mb-3 block">
      {{ 'products.addon.available_options' | t | default: 'Available options' }}
    </legend>
    <div class="product-addon__cards grid gap-3" data-addon-product-cards>
      {%- for addon_product in addon_products -%}
        {%- liquid
          assign first_variant = addon_product.selected_or_first_available_variant
          assign base_price = addon_products.first.selected_or_first_available_variant.price
          assign price_diff = first_variant.price | minus: base_price
          assign featured_image = first_variant.featured_image | default: addon_product.featured_image
        -%}
        <div class="product-addon__card{% if forloop.first %} is-selected{% endif %}">
          <input
            type="radio"
            class="sr-only"
            id="AddonProduct-{{ section_id }}-{{ addon_product.id }}"
            name="addon-product-{{ section_id }}"
            value="{{ addon_product.id }}"
            data-addon-product-radio
            data-product-handle="{{ addon_product.handle }}"
            data-first-variant-id="{{ first_variant.id }}"
            data-first-variant-price="{{ first_variant.price }}"
            {% if forloop.first %}checked{% endif %}
          />
          <label
            for="AddonProduct-{{ section_id }}-{{ addon_product.id }}"
            class="product-addon__card-label flex gap-3 cursor-pointer"
          >
            <div class="product-addon__card-media shrink-0 relative overflow-hidden">
              {%- if featured_image != blank -%}
                {{- featured_image | image_url: width: 120 | image_tag: loading: 'lazy', widths: '60,80,120,160', class: 'object-cover w-full h-full', alt: addon_product.title | escape -}}
              {%- else -%}
                <span aria-hidden="true" class="block w-full h-full">
                  {{- 'product-1' | placeholder_svg_tag: 'placeholder' -}}
                </span>
              {%- endif -%}
            </div>
            <div class="product-addon__card-content flex flex-col justify-center gap-1">
              <span class="product-addon__card-title font-medium text-sm leading-tight">
                {{- addon_product.title | escape -}}
              </span>
              <span class="product-addon__card-price text-xs">
                {%- if price_diff > 0 -%}
                  +{{ price_diff | money }}
                {%- elsif first_variant.price == 0 -%}
                  {{ 'products.addon.included' | t | default: 'Included' }}
                {%- else -%}
                  +{{ first_variant.price | money }}
                {%- endif -%}
              </span>
            </div>
            <div class="product-addon__card-check shrink-0 flex items-center">
              {%- render 'icon', icon: 'checkmark', size: 'sm' -%}
            </div>
          </label>
        </div>
      {%- endfor -%}
    </div>
  </fieldset>

  {%- # Variant Swatches for Each Add-on Product -%}
  {%- for addon_product in addon_products -%}
    <div
      class="product-addon__variants{% unless forloop.first %} hidden{% endunless %}"
      data-addon-variants="{{ addon_product.id }}"
      data-product-id="{{ addon_product.id }}"
    >
      {%- unless addon_product.has_only_default_variant -%}
        {%- for option in addon_product.options_with_values -%}
          {%- liquid
            # Check if this is a color option
            assign is_color = false
            assign swatch_trigger_list = 'products.general.color_swatch_trigger' | t | downcase | split: ','
            assign downcased_option = option.name | downcase
            for trigger in swatch_trigger_list
              assign swatch_trigger = trigger | strip
              if downcased_option contains swatch_trigger
                assign is_color = true
                break
              endif
            endfor
          -%}

          <fieldset class="product-addon__option mb-4">
            <legend class="form__label text-sm mb-2 flex items-center gap-2">
              <span class="text-accent font-medium">
                {{ 'products.addon.choose' | t | default: 'Choose a' }} {{ option.name }}:
              </span>
              <span class="font-medium" data-selected-option="{{ option.name }}">
                {{ option.selected_value }}
              </span>
            </legend>

            <ul class="swatches swatches--{{ settings.rounded_swatch }} flex items-start flex-wrap gap-3">
              {%- for value in option.values -%}
                {%- liquid
                  # Find variant for this option value to get price
                  assign variant_for_value = nil
                  for variant in addon_product.variants
                    if variant.option1 == value or variant.option2 == value or variant.option3 == value
                      assign variant_for_value = variant
                      break
                    endif
                  endfor
                -%}
                <li class="flex flex-col items-center gap-1">
                  <input
                    type="radio"
                    class="sr-only peer"
                    id="Addon-{{ section_id }}-{{ addon_product.id }}-{{ option.name | handle }}-{{ forloop.index0 }}"
                    name="addon-{{ addon_product.id }}-{{ option.name | handle }}"
                    value="{{ value | escape }}"
                    data-variant-id="{{ variant_for_value.id }}"
                    data-variant-price="{{ variant_for_value.price }}"
                    data-variant-available="{{ variant_for_value.available }}"
                    {% if option.selected_value == value %}checked{% endif %}
                    {% unless variant_for_value.available %}disabled{% endunless %}
                  />

                  {%- if is_color -%}
                    {%- liquid
                      # Swatch background logic
                      assign swatch_image = blank
                      assign swatch_fallback = value | split: ' ' | last | handle

                      if value.swatch != blank
                        if value.swatch.image
                          assign swatch_image = value.swatch.image | image_url: width: 72
                        elsif value.swatch.color
                          assign swatch_fallback = value.swatch.color
                        endif
                      elsif variant_for_value.featured_image
                        assign swatch_image = variant_for_value.featured_image | image_url: width: 72
                      endif

                      # Check settings for custom swatch colors
                      if settings.swatch_config != blank and swatch_image == blank
                        assign value_downcase = value | downcase
                        assign swatch_config = settings.swatch_config | newline_to_br | split: '<br />'
                        for swatch in swatch_config
                          assign swatch_parts = swatch | strip | split: ':'
                          assign swatch_name = swatch_parts.first | downcase | strip
                          if swatch_name == value_downcase
                            assign swatch_value = swatch_parts.last | strip
                            if swatch_value contains '#'
                              assign swatch_fallback = swatch_value
                            endif
                            break
                          endif
                        endfor
                      endif
                    -%}
                    <label
                      for="Addon-{{ section_id }}-{{ addon_product.id }}-{{ option.name | handle }}-{{ forloop.index0 }}"
                      class="color-swatch{% if swatch_image != blank %} with-image{% endif %}{% unless variant_for_value.available %} unavailable{% endunless %} cursor-pointer block relative"
                      title="{{ value | escape }}"
                      style="--swatch-background: {{ swatch_fallback }};{% if swatch_image != blank %}--swatch-background-image: url({{ swatch_image }});{% endif %}"
                    >
                      <span class="sr-only">{{ value | escape }}</span>
                      <span class="tooltip opacity-0 pointer-events-none text-xs rounded-full z-10">{{ value | escape }}</span>
                    </label>
                  {%- else -%}
                    <label
                      for="Addon-{{ section_id }}-{{ addon_product.id }}-{{ option.name | handle }}-{{ forloop.index0 }}"
                      class="label-swatch{% unless variant_for_value.available %} unavailable{% endunless %} text-sm font-medium leading-none cursor-pointer block relative px-3 py-2 border rounded"
                      title="{{ value | escape }}"
                    >
                      {{ value }}
                    </label>
                  {%- endif -%}

                  {%- # Price indicator below swatch -%}
                  {%- if variant_for_value.price > 0 -%}
                    <span class="text-xs text-opacity">
                      +{{ variant_for_value.price | money_without_trailing_zeros }}
                    </span>
                  {%- else -%}
                    <span class="text-xs text-opacity">
                      {{ 'products.addon.included_short' | t | default: 'Incl.' }}
                    </span>
                  {%- endif -%}
                </li>
              {%- endfor -%}
            </ul>
          </fieldset>
        {%- endfor -%}
      {%- endunless -%}

      {%- # Store variant data as JSON for JS -%}
      <script type="application/json" data-addon-variants-json>
        {{ addon_product.variants | json }}
      </script>
    </div>
  {%- endfor -%}

  {%- # Hidden checkbox for ProductForm bundles mechanism -%}
  <input
    type="checkbox"
    name="bundles"
    value="{{ default_variant.id }}"
    form="{{ product_form_id }}"
    checked
    hidden
    data-addon-variant-input
  />

  {%- # Price summary -%}
  <div class="product-addon__summary flex items-center justify-between py-3 border-t mt-4" data-addon-summary>
    <span class="text-sm">{{ 'products.addon.selected' | t | default: 'Add-on' }}:</span>
    <span class="font-medium" data-addon-price>
      {%- if default_variant.price == 0 -%}
        {{ 'products.addon.included' | t | default: 'Included' }}
      {%- else -%}
        +{{ default_variant.price | money }}
      {%- endif -%}
    </span>
  </div>
</product-addon>
