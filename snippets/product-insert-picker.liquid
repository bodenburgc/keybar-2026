{%- doc -%}
  Renders a multi-select insert product picker with checkbox cards.

  Displays available tool inserts (Pick Insert, Phillips Screwdriver, Bottle Bomber)
  with checkboxes for multi-select. Collapsed state shows thumbnail preview grid.
  Inserts with variants show a "Change" link that opens a compact popover.

  @param {object} product - The main product being viewed
  @param {string} section_id - Section ID for unique element IDs
  @param {object} block - Block settings from schema
  @param {string} product_form_id - ID of the main product form

  @example
  {%- render 'product-insert-picker',
    product: product,
    section_id: section.id,
    block: block,
    product_form_id: product_form_id
  -%}
{%- enddoc -%}

{%- liquid
  # Check if insert addon is enabled for this product
  assign insert_enabled = product.metafields.custom.enable_insert.value
  unless insert_enabled
    break
  endunless

  # Get insert products from product metafield
  assign insert_products = product.metafields.custom.insert_add_on_product.value
  if insert_products == blank or insert_products.size == 0
    break
  endif

  # Customizable text from metafields
  assign insert_title = product.metafields.custom.insert_addon_title.value
  if insert_title == blank
    assign insert_title = 'products.insert.section_title' | t | default: 'Tool Inserts'
  endif
-%}

{{ 'product-insert.css' | asset_url | stylesheet_tag }}
<script src="{{ 'product-insert.js' | asset_url }}" defer="defer"></script>

<product-insert-picker
  class="product-insert block"
  id="ProductInsert-{{ section_id }}"
  data-section-id="{{ section_id }}"
  data-base-price="{{ product.selected_or_first_available_variant.price }}"
  data-form-id="{{ product_form_id }}"
  data-currency-symbol="{{ cart.currency.symbol }}"
  data-no-inserts-text="{{ 'products.insert.no_inserts' | t | default: 'None' }}"
  data-product-id="{{ product.id }}"
  {{ block.shopify_attributes }}
>
  {%- # Compact Collapsed Row -%}
  <div
    class="product-insert__row"
    data-insert-main-card
    role="button"
    tabindex="0"
    aria-expanded="false"
    aria-controls="InsertDetails-{{ section_id }}"
  >
    <span class="product-insert__row-label">{{ insert_title }}</span>
    <span class="product-insert__row-value" data-insert-summary>
      {{ 'products.insert.no_inserts' | t | default: 'None' }}
    </span>
    <span class="product-insert__row-price" data-insert-badge></span>
    <span class="product-insert__row-action" aria-hidden="true">
      <span data-insert-customize-text>{{ 'products.insert.add' | t | default: 'Add' }}</span>
      {%- render 'icon', icon: 'chevron-down', size: 'sm' -%}
    </span>
  </div>

  {%- # Expanded Details Panel -%}
  <div class="product-insert__details" id="InsertDetails-{{ section_id }}" data-insert-details hidden>
    <div class="product-insert__cards">
      {%- for insert_product in insert_products -%}
        {%- liquid
          assign first_variant = insert_product.selected_or_first_available_variant | default: insert_product.first_available_variant
          assign featured_image = first_variant.featured_image | default: insert_product.featured_image
          assign has_variants = false
          assign has_color_option = false
          unless insert_product.has_only_default_variant
            assign has_variants = true
          endunless
          assign variant_display = first_variant.option1 | default: ''
          if variant_display == 'Default Title' or variant_display == 'None'
            assign variant_display = ''
          endif

          # Detect color option for inline mini swatches
          assign color_selected_value = ''
          if has_variants
            for option in insert_product.options_with_values
              assign swatch_trigger_list = 'products.general.color_swatch_trigger' | t | downcase | split: ','
              assign downcased_option = option.name | downcase
              for trigger in swatch_trigger_list
                assign swatch_trigger = trigger | strip
                if downcased_option contains swatch_trigger
                  assign has_color_option = true
                  assign color_selected_value = option.selected_value
                  break
                endif
              endfor
              if has_color_option
                break
              endif
            endfor
          endif
        -%}

        <label
          class="product-insert__card"
          data-insert-card
          data-product-id="{{ insert_product.id }}"
          data-product-title="{{ insert_product.title | escape }}"
          data-default-price="{{ first_variant.price }}"
        >
          {%- # Checkbox -%}
          <input
            type="checkbox"
            class="sr-only"
            data-insert-checkbox
            aria-label="{{ insert_product.title | escape }}"
          />
          <span class="product-insert__checkbox" aria-hidden="true"></span>
          <span class="product-insert__card-status" aria-hidden="true">Added</span>

          {%- # Image -%}
          <div class="product-insert__card-media">
            {%- if featured_image != blank -%}
              {{- featured_image | image_url: width: 96 | image_tag: loading: 'lazy', widths: '48,96', class: 'product-insert__card-img', alt: insert_product.title | escape -}}
            {%- else -%}
              <span class="product-insert__card-placeholder">
                {%- render 'icon', icon: 'product', size: 'md' -%}
              </span>
            {%- endif -%}
          </div>

          {%- # Info -%}
          <div class="product-insert__card-info">
            <span class="product-insert__card-title">{{ insert_product.title | escape }}</span>
            <span class="product-insert__card-meta">
              <span class="product-insert__card-price">+{{ first_variant.price | money_without_trailing_zeros }}</span>
              {%- if has_color_option -%}
                {%- liquid
                  assign display_color_name = color_selected_value | escape
                  assign color_check = color_selected_value | downcase
                  if color_check == 'none'
                    assign display_color_name = 'Standard'
                  endif
                -%}
                <span class="product-insert__card-color-name" data-insert-color-name data-for-product="{{ insert_product.id }}">
                  · {{ display_color_name }}
                </span>
              {%- endif -%}
            </span>

            {%- # Inline mini color swatches (shown directly on card) -%}
            {%- if has_color_option -%}
              {%- for option in insert_product.options_with_values -%}
                {%- liquid
                  assign is_color = false
                  assign swatch_trigger_list_inner = 'products.general.color_swatch_trigger' | t | downcase | split: ','
                  assign downcased_option_inner = option.name | downcase
                  for trigger in swatch_trigger_list_inner
                    assign swatch_trigger_inner = trigger | strip
                    if downcased_option_inner contains swatch_trigger_inner
                      assign is_color = true
                      break
                    endif
                  endfor
                -%}
                {%- if is_color -%}
                  <div class="product-insert__mini-swatches" data-insert-mini-swatches data-for-product="{{ insert_product.id }}">
                    {%- for value in option.values -%}
                      {%- liquid
                        assign value_lower_check = value | downcase
                        assign is_plain_variant = false
                        if value_lower_check == 'none'
                          assign is_plain_variant = true
                        endif

                        assign variant_for_value = nil
                        for variant in insert_product.variants
                          if variant.option1 == value or variant.option2 == value or variant.option3 == value
                            assign variant_for_value = variant
                            break
                          endif
                        endfor

                        assign mini_swatch_bg = value | split: ' ' | last | handle
                        assign mini_swatch_image = blank

                        if value.swatch != blank
                          if value.swatch.image
                            assign mini_swatch_image = value.swatch.image | image_url: width: 150
                            assign mini_swatch_bg = 'transparent'
                          elsif value.swatch.color
                            assign mini_swatch_bg = value.swatch.color
                          endif
                        endif

                        if settings.swatch_config != blank
                          assign value_downcase = value | downcase
                          assign swatch_config = settings.swatch_config | newline_to_br | split: '<br />'
                          for swatch in swatch_config
                            assign swatch_parts = swatch | strip | split: ':'
                            assign swatch_name = swatch_parts.first | downcase | strip
                            if swatch_name == value_downcase
                              assign swatch_value = swatch_parts.last | strip
                              if swatch_value contains '#'
                                assign mini_swatch_bg = swatch_value
                              elsif swatch_value contains '.png' or swatch_value contains '.jpg' or swatch_value contains '.svg'
                                assign mini_swatch_image = swatch_value | file_url
                              endif
                              break
                            endif
                          endfor
                        endif

                        # Hardcoded color mappings for common insert colors
                        assign value_lower = value | downcase
                        case value_lower
                          when 'fuchsia'
                            assign mini_swatch_bg = '#ff00ff'
                          when 'red'
                            assign mini_swatch_bg = '#dc2626'
                          when 'blue'
                            assign mini_swatch_bg = '#2563eb'
                          when 'green'
                            assign mini_swatch_bg = '#16a34a'
                          when 'gold'
                            assign mini_swatch_bg = '#d4af37'
                          when 'black'
                            assign mini_swatch_bg = '#1c1f22'
                          when 'purple'
                            assign mini_swatch_bg = '#7c3aed'
                          when 'orange'
                            assign mini_swatch_bg = '#ea580c'
                        endcase
                      -%}
                      {%- liquid
                        assign swatch_label = value | escape
                        if is_plain_variant
                          assign swatch_label = 'Standard'
                        endif
                      -%}
                      <span
                        class="product-insert__mini-swatch{% if option.selected_value == value %} is-active{% endif %}{% if is_plain_variant %} is-plain{% endif %}"
                        data-insert-mini-swatch
                        data-variant-id="{{ variant_for_value.id }}"
                        data-variant-price="{{ variant_for_value.price }}"
                        data-swatch-value="{{ value | escape }}"
                        title="{{ swatch_label }}"
                        style="--mini-swatch-bg: {{ mini_swatch_bg }};{% if mini_swatch_image != blank %} --mini-swatch-image: url({{ mini_swatch_image }});{% endif %}"
                      ><span class="product-insert__mini-swatch-tooltip">{{ swatch_label }}</span></span>
                    {%- endfor -%}
                  </div>
                {%- endif -%}
              {%- endfor -%}
            {%- elsif has_variants -%}
              <div class="product-insert__card-variant">
                <span class="product-insert__card-variant-value" data-insert-variant-value>{{ variant_display }}</span>
                {%- if variant_display != blank -%}
                  <span class="product-insert__card-variant-sep">&nbsp;&middot;&nbsp;</span>
                {%- endif -%}
                <button type="button" class="product-insert__change-link" data-insert-change>
                  {{ 'products.insert.change' | t | default: 'Change' }}
                </button>
              </div>
            {%- endif -%}
          </div>

          {%- # Variant Popover (for products with multiple variants, non-color) -%}
          {%- if has_variants and has_color_option == false -%}
            <div class="product-insert__popover" data-insert-popover data-for-product="{{ insert_product.id }}" hidden>
              {%- for option in insert_product.options_with_values -%}
                <fieldset class="product-insert__popover-fieldset" style="border:none;padding:0;margin:0;">
                  <legend class="product-insert__popover-label">
                    <span class="product-insert__popover-option-name">{{ option.name }}:</span>
                    <span class="product-insert__popover-option-value" data-insert-popover-selected>{{ option.selected_value }}</span>
                  </legend>

                  <ul class="product-insert__popover-swatches">
                    {%- for value in option.values -%}
                      {%- liquid
                        assign variant_for_value = nil
                        for variant in insert_product.variants
                          if variant.option1 == value or variant.option2 == value or variant.option3 == value
                            assign variant_for_value = variant
                            break
                          endif
                        endfor
                      -%}
                      <li class="product-insert__popover-swatch-item">
                        <input
                          type="radio"
                          class="sr-only"
                          id="Insert-{{ section_id }}-{{ insert_product.id }}-{{ option.name | handle }}-{{ forloop.index0 }}"
                          name="insert-{{ insert_product.id }}-{{ option.name | handle }}"
                          value="{{ value | escape }}"
                          data-variant-id="{{ variant_for_value.id }}"
                          data-variant-price="{{ variant_for_value.price }}"
                          data-variant-available="{{ variant_for_value.available }}"
                          {% if option.selected_value == value %}checked{% endif %}
                          {% unless variant_for_value.available %}disabled{% endunless %}
                        />
                        <label
                          for="Insert-{{ section_id }}-{{ insert_product.id }}-{{ option.name | handle }}-{{ forloop.index0 }}"
                          class="product-insert__popover-label-swatch{% unless variant_for_value.available %} unavailable{% endunless %}"
                          title="{{ value | escape }}"
                        >
                          {{ value }}
                        </label>
                        <span class="product-insert__popover-swatch-price">
                          +{{ variant_for_value.price | money_without_trailing_zeros }}
                        </span>
                      </li>
                    {%- endfor -%}
                  </ul>
                </fieldset>
              {%- endfor -%}

              <button type="button" class="product-insert__popover-done" data-insert-popover-done>
                {{ 'products.insert.done' | t | default: 'Done' }}
              </button>

              {%- # Variant data JSON -%}
              <script type="application/json" data-insert-variants-json>
                {{ insert_product.variants | json }}
              </script>
            </div>
          {%- endif -%}

          {%- # Variant data JSON for color swatch products -%}
          {%- if has_variants and has_color_option -%}
            <script type="application/json" data-insert-variants-json data-for-product="{{ insert_product.id }}">
              {{ insert_product.variants | json }}
            </script>
          {%- endif -%}
        </label>
      {%- endfor -%}
    </div>
  </div>

  {%- # Hidden inputs for form submission — one per insert product -%}
  {%- for insert_product in insert_products -%}
    {%- assign first_variant = insert_product.selected_or_first_available_variant | default: insert_product.first_available_variant -%}
    <input
      type="checkbox"
      class="sr-only"
      name="bundles"
      value="{{ first_variant.id }}"
      form="{{ product_form_id }}"
      data-insert-variant-input
      data-product-id="{{ insert_product.id }}"
    />
  {%- endfor -%}
</product-insert-picker>
